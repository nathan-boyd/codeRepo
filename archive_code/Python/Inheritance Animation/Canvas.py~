from Tkinter import *
import Tkinter
from Panel import*
from Canvas import *
from Animator import *

import tkFileDialog

class Canvas(Tk):
  def __init__(self):                                     #constructor
    Tk.__init__(self)                                     #calling parent constructor


    self.currentFrame = 0
    self.totalFrame = 0
    self.fileName = ""                                    #file to be imported
    self.saveFile = "lastSavedAscii.ascii"                #save location of edited ASCII
    self.ASCII_Panels = []

    self.configure(bg="white")  
    self.title("Canvas Wrapper")

    mainFrame = Frame(self, bg="white")                   #Frame to hold buttons and admin 
    designFrame = Frame(self, bg="white")                 #Frame to design the ASCII

    self.quitButton = Button(mainFrame, text="QUIT", fg="red", command=self.quit).grid(row=0,column=1)
    self.importButton = Button(mainFrame, text="Import ASCII", fg="blue", command=lambda: self.ImportFile("new")).grid(row=0,column=2)
    self.animateButton = Button(mainFrame, text="Animate", fg="blue", command=lambda: self.MakeAnimation()).grid(row=0,column=3)
    self.aboutButton = Button(mainFrame, text="About", fg="red", command=lambda: self.ShowAbout()).grid(row=0,column=4)
    self.stepRightButton = Button(mainFrame, text="Step Right ->", fg="blue", command=lambda: self.Step("right")).grid(row=0,column=5)
    self.stepLeftButton = Button(mainFrame, text="<- Step Left", fg="blue", command=lambda: self.Step("left")).grid(row=0,column=0)

    self.textArea = Text(designFrame, state="normal")    #Text area to generate and edit ASCII

    self.textArea.grid()
    mainFrame.grid()
    designFrame.grid()

  def ShowAbout(self):              ###############This sucks maybe make a class or frame 
    import tkMessageBox             # need to make a scrolling text pane, maybe another Text() area
    info = []
    file = open("aboutDoc.txt")
    info = file.read()
    tkMessageBox.showinfo("About this application", info)

  def Step(self, direction):                              #step into the next frame
    if self.fileName == "":                               #If the file name is empty load up a new file
      self.ImportFile("old")

    self.textArea.insert(END, "&")                        #& used as panel delimeter
    self.SavePanel()                                      #save the panel to a temp file

    if self.currentFrame >= self.totalFrame:              
      self.totalFrame += 1
      self.UpdatePanel("append")
    else: 
      self.UpdatePanel("update")
    
    self.SaveASCII()
    self.textArea.delete(1.0,END)

    if direction == "left":
      self.currentFrame -= 1
    elif direction == "right":
      self.currentFrame += 1

    try:
      print "Current frame " + str(self.currentFrame) + " Total Frames " + str(self.totalFrame)
      tempPanel = self.ASCII_Panels[self.currentFrame].getPanel()
      for index in range(len(tempPanel)):
        tempPanel[index] = tempPanel[index].replace("&"," ")
        self.textArea.insert(INSERT, tempPanel[index])
        self.textArea.insert(INSERT, "\n")
    except:
      pass
    
    self.textArea.delete(END,END)
    self.update()

  def UpdatePanel(self, type):                                #update the ASCII array to reflect edited panels
    localPanel = []         
    f = open("temp.tmp", 'r')
    for row in f:
      localPanel.append(row.rstrip())
      if row.count("&") != 0:
        panel = Panel(localPanel)               
        if type == "update":
          self.ASCII_Panels[self.currentFrame] = panel
        else:
          self.ASCII_Panels.append(panel)
    f.close()
 
  def SavePanel(self):                                        #Copies the text area and saves the updated panel             
    aBuffer_Panels = []
    temp = self.textArea.get(1.0, END)
    panel = Panel(temp)

    file = open("temp.tmp",'w')
    file.write(panel.getPanel())
    file.close()

  def SaveASCII(self):                                        #wrtie the entire list of panels to file
    file = open(self.saveFile, 'w')
    for index in range(len(self.ASCII_Panels)):               ######################################need to implement a file chooser if the saveFile is empty
      panel = self.ASCII_Panels[index]
      panel.writePanel(self.saveFile)
      
  def ImportFile(self, type):                                  #loads a file from disk into an array of panels
    
    if type == "new" or self.fileName == "":                   #if the type is new or the file name doesnt exist
      self.fileName = tkFileDialog.askopenfilename() 
      self.ImportFile("old")
   
    del self.ASCII_Panels[:]                                   #clear the values of the panel array 

    localPanel = []
    f = open(self.fileName, 'r')
    for row in f:
      localPanel.append(row.rstrip())
      if row.count("&") != 0:
        panel = Panel(localPanel)
        del localPanel
        localPanel = []                   
        self.ASCII_Panels.append(panel)
    f.close()
    self.totalFrame = len(self.ASCII_Panels)

  def MakeAnimation(self):                                  #passes a file name to the Animator class
                                                            #renders the animation in a seperate window
    if self.fileName == "":                                 #If the file name is empty load up a new file
      self.ImportFile("old")

    self.textArea.insert(END, "&")                          #& used as panel delimeter
    self.SavePanel()                                        #save the panel to a temp file
    self.textArea.delete(1.0,END)
    self.SaveASCII()

    self.newAnimator = Animator(self.saveFile)  ##############bugs here need to ensure that its loading the currentely edited animation
    self.newAnimator.Animate()
    self.newAnimator.destroy()


def main():
  print "Canvas Main called"
  canvas = Canvas()
  canvas.mainloop()
  
if __name__ == "__main__":
  main()
